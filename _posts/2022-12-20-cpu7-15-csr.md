---
title: CSR模块
published: true
---

`````verilog
 387    cpu7_csr csr(                                                                                                                             
 388       .clk               (clk               ),                                                                                               
 389       .resetn            (resetn            ),                                                                                               
 390       .csr_rdata         (csr_byp_rdata_d   ),                                                                                               
 391       .csr_raddr         (ecl_csr_raddr_d   ),                                                                                               
 392       .csr_waddr         (ecl_csr_waddr_m   ),                                                                                               
 393       .csr_wdata         (byp_csr_wdata_m   ),                                                                                               
 394       .csr_wen           (ecl_csr_wen_m     )                                                                                                
 395       ); 
`````

在_d的时候读csr寄存器的内容。

处理csrwr csrxchg的时候需要读rd的内容，写到csr寄存器里。因为读到的rd的内容需要经过byp处理，所以在_e写csr寄存器来不及，只能在_m写。

`````verilog
 695    assign csr_wdata_e = byp_rs2_data_e;
`````

并且_e的时候还要处理csrxchg里的mask。

但这样就出现个问题，csr寄存器也需要byp。

比如csrwr后面紧跟着csrrd，csrwr在_m时写csr寄存器，而csrrd在_d的时候就去读了，比如下面这段代码。

`````asm
        addi.w   $r4, $r0, -1            # r4 = ffffffff
        csrwr    $r4, 0x0                # only crmd.ie (bit 2) can be set
#       nop
        csrrd    $r5, 0x0                # crmd
        addi.w   $r5, $r5, 0x56
`````

没有nop隔开的话，csrrd读到的还是0。



