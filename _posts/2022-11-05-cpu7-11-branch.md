---
title: branch logic
published: true
---

`````verilog
exu/rtl/sparc_exu.v


   sparc_exu_ecl ecl(
                     .so                (short_so0),
                     .si                (short_scan0_1),
                     .rst_tri_en        (mux_drive_disable),
                     .byp_ecl_wrccr_data_w(byp_irf_rd_data_w[7:0]),
                     .alu_ecl_adder_out_31_e(exu_ifu_brpc_e[31]),
                     .byp_ecl_rd_data_3lsb_m(exu_tlu_wsr_data_m[2:0]),
                     .alu_ecl_adder_out_7_0_e(exu_ifu_brpc_e[7:0]),

...





   sparc_exu_alu alu(
                     .byp_alu_rs3_data_e(exu_lsu_rs3_data_e[63:0]),
                     .so                (scan0_2),
                     .si                (scan0_1),
                     .ifu_lsu_casa_e (ecl_alu_casa_e),
                     /*AUTOINST*/
                     // Outputs
                     .alu_byp_rd_data_e (alu_byp_rd_data_e[63:0]),
                     .exu_ifu_brpc_e    (exu_ifu_brpc_e[47:0]),
                     .exu_lsu_ldst_va_e (exu_lsu_ldst_va_e[47:0]),
                     .exu_lsu_early_va_e(exu_lsu_early_va_e[10:3]),
                     .exu_mmu_early_va_e(exu_mmu_early_va_e[7:0]),
                     .alu_ecl_add_n64_e (alu_ecl_add_n64_e),
                     .alu_ecl_add_n32_e (alu_ecl_add_n32_e),
                     .alu_ecl_log_n64_e (alu_ecl_log_n64_e),
                     .alu_ecl_log_n32_e (alu_ecl_log_n32_e),
...


`````

exu_ifu_brpc_e是exu给ifu的branch地址，可以看到这部分是在_e得出的。

从文档里也看到branch address的计算也是复用了ALU，应该就是ALU里的exu_ifu_brpc_e。


而在sparc_ifu.v里却有这个

`````verilog
   // Branch Logic
   sparc_ifu_dcl  dcl(
                      .so               (scan0_3),
                      .si               (scan0_2),
                                  .dtu_dcl_opf2_d       (dtu_inst_d[7]),
                      .fdp_dcl_op_s     (fdp_dtu_inst_s[31:30]),
                      .fdp_dcl_op3_s    (fdp_dtu_inst_s[24:19]),

`````

在ifu里，branch就应该是在decode阶段。

在OpenSPARC T1 Microarchitecture Specification里也有这一句。

> 2.3.14 Instruction Decode
>
> ...
> 
>        The branch condition is also evaluated in the D-stage, and the decision for annulling
>        a delay slot is made in this stage as well.


sparc_ifu_dcl.v的注释里也说了这一点，这到要好好看看opensparc里的branch是怎样实现的。

`````verilog
ifu/rtl/sparc_ifu_dcl.v

////////////////////////////////////////////////////////////////////////
/*
//  Module Name: sparc_ifu_dcl
//  Description:        
//   The decode control logic block does branch condition evaluation,
//   delay slot management, and appropriate condition code
//   selection.  It also executes the tcc instruction and kills the E
//   stage instruction if a move did not succeed.  The DCL block is
//   also responsible for generating the correct select signals to
//   choose the branch offset and immediate operand.
//
*/
////////////////////////////////////////////////////////////////////////

`````

还在Microarchitecture Specification里看到这一段。


> 2.3.10 Thread Selection Policy
> 
> ...
> 
>        A thread could become unavailable due to one of these reasons:
> 
>        1. The thread is executing one of the long latency instructions, such as load, branch,
>           multiplication, division, and so on.


branch也是long latency instructions？

load是，store看来不是。


